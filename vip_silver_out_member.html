<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì™¸ë¶€ ì¸ì› ë°ì´í„° ê´€ë¦¬</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        
        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 10px; box-sizing: border-box; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group input { flex: 1; padding: 8px; }
        
        button { padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .add-btn { background-color: #4CAF50; }
        .add-btn:hover { background-color: #45a049; }
        
        /* ë²„íŠ¼ ì •ë ¬ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .table-header-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
        .table-title { margin: 0; }
        .button-group { display: flex; justify-content: flex-end; gap: 10px; }
        
        .save-btn { background-color: #008CBA; }
        .save-btn:hover { background-color: #007bb5; }
        .bulk-delete-btn { background-color: #ff9800; }
        .bulk-delete-btn:hover { background-color: #e68a00; }
        .remove-dup-btn { background-color: #9c27b0; }
        .remove-dup-btn:hover { background-color: #7b1fa2; }
        .delete-btn { background-color: #f44336; padding: 4px 8px; font-size: 12px; border-radius: 3px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: white; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #333; color: white; font-weight: bold; }
        td.editable { cursor: pointer; }
        td.editable:hover { background-color: #f1f1f1; }
        td input[type="text"] { width: 90%; padding: 5px; text-align: center; }
        td input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸ‘¥ íšŒì› ë°ì´í„° ê´€ë¦¬ (outmem)</h2>

    <div class="section">
        <h3>ì¼ê´„ ë°ì´í„° ì…ë ¥</h3>
        <textarea id="bulkInput" placeholder="ë³µì‚¬í•œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ì˜ˆ: ê¶Œì¼ë´‰ 01076689073 ì´ì „ì€)"></textarea>
        <button id="addBulkBtn" class="add-btn">ì¼ê´„ ì¶”ê°€í•˜ê¸°</button>
    </div>

    <div class="section">
        <h3>ê°œë³„ í–‰ ì¶”ê°€</h3>
        <div class="input-group">
            <input type="text" id="nameInput" placeholder="íšŒì›ëª…">
            <input type="text" id="phoneInput" placeholder="ì „í™”ë²ˆí˜¸">
            <input type="text" id="managerInput" placeholder="ë‹´ë‹¹ì">
        </div>
        <button id="addSingleBtn" class="add-btn">ê°œë³„ ì¶”ê°€í•˜ê¸°</button>
    </div>

    <div class="section" style="background-color: transparent; border: none; padding: 0;">
        <div class="table-header-container">
            <h3 class="table-title">ë°ì´í„° í‘œ (ë”ë¸” í´ë¦­í•˜ì—¬ ìˆ˜ì •)</h3>
            <div class="button-group">
                <button id="removeDuplicatesBtn" class="remove-dup-btn">ğŸ§¹ ì¤‘ë³µ ëª©ë¡ ì œê±°</button>
                <button id="deleteSelectedBtn" class="bulk-delete-btn">ğŸ—‘ï¸ ì„ íƒ í•­ëª© ì‚­ì œ</button>
                <button id="saveFirebaseBtn" class="save-btn">ğŸ’¾ Firebaseì— í‘œ ì „ì²´ ì €ì¥</button>
            </div>
        </div>
        
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="width: 40px;">ì„ íƒ</th>
                    <th>íšŒì›ëª…</th>
                    <th>ì „í™”ë²ˆí˜¸</th>
                    <th>ë‹´ë‹¹ì</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMu3NnCwJlkAoCmouYu92cP4Rha4SPFKo",
            authDomain: "fuinv-f980f.firebaseapp.com",
            projectId: "fuinv-f980f",
            storageBucket: "fuinv-f980f.firebasestorage.app",
            messagingSenderId: "400376860655",
            appId: "1:400376860655:web:ec0343d8eeef707893f01a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "outmem", "mainData");
        const tableBody = document.getElementById('tableBody');

        let lastCheckedBox = null;

        // ì…€ ì•ˆì˜ í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ìˆ˜ì • ì¤‘ì¼ ë•Œ ëŒ€ë¹„)
        function getCellText(cell) {
            const input = cell.querySelector('input[type="text"]');
            return input ? input.value.trim() : cell.innerText.trim();
        }

        // 1. ì´ˆê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadData() {
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data().list || [];
                    data.forEach(item => addRowToTable(item.name, item.phone, item.manager));
                }
            } catch (e) {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
            }
        }

        // 2. í‘œì— í–‰ ì¶”ê°€
        function addRowToTable(name, phone, manager) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="row-checkbox"></td>
                <td class="editable">${name}</td>
                <td class="editable">${phone}</td>
                <td class="editable">${manager}</td>
                <td><button class="delete-btn">ì‚­ì œ</button></td>
            `;

            // ì¸ë¼ì¸ ìˆ˜ì •
            const cells = tr.querySelectorAll('.editable');
            cells.forEach(cell => {
                cell.addEventListener('dblclick', function() {
                    if (this.querySelector('input')) return; 
                    const currentText = this.innerText;
                    this.innerHTML = `<input type="text" value="${currentText}">`;
                    const input = this.querySelector('input');
                    input.focus();

                    input.addEventListener('blur', finishEdit);
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') finishEdit.call(this);
                    });

                    function finishEdit() {
                        const newText = this.value;
                        cell.innerText = newText.trim() === '' ? currentText : newText;
                    }
                });
            });

            // ê°œë³„ ì‚­ì œ
            tr.querySelector('.delete-btn').addEventListener('click', function() {
                tr.remove();
            });

            tableBody.appendChild(tr);
        }

        // 3. ì¼ê´„ ì¶”ê°€ (ëˆ„ë½ ì•Œë¦¼ í¬í•¨)
        document.getElementById('addBulkBtn').addEventListener('click', () => {
            const text = document.getElementById('bulkInput').value.trim();
            if (!text) return alert("ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const lines = text.split('\n');
            const errorMessages = [];
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return; 

                const parts = trimmedLine.split(/\s+/);
                
                if (parts.length >= 3) {
                    addRowToTable(parts[0], parts[1], parts[2]);
                } else {
                    let missingInfo = "";
                    if (parts.length === 1) {
                        missingInfo = "ì „í™”ë²ˆí˜¸, ë‹´ë‹¹ì ëˆ„ë½";
                    } else if (parts.length === 2) {
                        missingInfo = "ë‹´ë‹¹ì (ë˜ëŠ” ì „í™”ë²ˆí˜¸) ëˆ„ë½";
                    }
                    errorMessages.push(`[${index + 1}ë²ˆì§¸ ì¤„] "${trimmedLine}" -> ${missingInfo}`);
                }
            });

            document.getElementById('bulkInput').value = ''; 

            if (errorMessages.length > 0) {
                alert("âš ï¸ ë‹¤ìŒ í–‰ë“¤ì€ ì…ë ¥ê°’ì´ ë¶€ì¡±í•˜ì—¬ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤:\n\n" + errorMessages.join("\n"));
            }
        });

        // 4. ê°œë³„ ì¶”ê°€
        document.getElementById('addSingleBtn').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const manager = document.getElementById('managerInput').value.trim();

            if (!name || !phone || !manager) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            addRowToTable(name, phone, manager);
            
            document.getElementById('nameInput').value = '';
            document.getElementById('phoneInput').value = '';
            document.getElementById('managerInput').value = '';
        });

        // 5. ì¤‘ë³µ ëª©ë¡ ì œê±° (ìƒˆ ê¸°ëŠ¥)
        document.getElementById('removeDuplicatesBtn').addEventListener('click', () => {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const seen = new Set();
            const rowsToRemove = [];

            // ìœ„ì—ì„œë¶€í„° í•œ ì¤„ì”© ê²€ì‚¬
            rows.forEach(row => {
                const cells = row.querySelectorAll('td.editable');
                if (cells.length >= 2) {
                    const name = getCellText(cells[0]);
                    const phone = getCellText(cells[1]);
                    // ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ í•©ì¹œ ê³ ìœ  í‚¤ ìƒì„± (ì˜ˆ: "í™ê¸¸ë™|01012345678")
                    const uniqueKey = name + '|' + phone;

                    if (seen.has(uniqueKey)) {
                        // ì´ë¯¸ ë³¸ ì ì´ ìˆëŠ” ì¡°í•©ì´ë©´ ì‚­ì œ ëŒ€ê¸°ì—´ì— ì¶”ê°€
                        rowsToRemove.push(row);
                    } else {
                        // ì²˜ìŒ ë³´ëŠ” ì¡°í•©ì´ë©´ ê¸°ë¡
                        seen.add(uniqueKey);
                    }
                }
            });

            if (rowsToRemove.length === 0) {
                return alert("ì¤‘ë³µëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            }

            // í™•ì¸(ì˜ˆ) / ì·¨ì†Œ(ì•„ë‹ˆì˜¤) íŒì—…ì°½
            const isConfirm = confirm(`ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ê°€ ëª¨ë‘ ë™ì¼í•œ ì¤‘ë³µ ë°ì´í„°ê°€ ${rowsToRemove.length}ê°œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ì— ìˆëŠ” 1ê°œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì¤‘ë³µê°’ì€ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
            
            if (isConfirm) {
                rowsToRemove.forEach(row => row.remove());
                lastCheckedBox = null; // ë‹¤ì¤‘ ì„ íƒ ê¼¬ì„ ë°©ì§€
                alert("ì¤‘ë³µ ë°ì´í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        });

        // 6. Shift+Click ë‹¤ì¤‘ ì„ íƒ ì´ë²¤íŠ¸
        tableBody.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('row-checkbox')) {
                const checkboxes = Array.from(tableBody.querySelectorAll('.row-checkbox'));
                
                if (e.shiftKey && lastCheckedBox) {
                    const start = checkboxes.indexOf(lastCheckedBox);
                    const end = checkboxes.indexOf(e.target);
                    const min = Math.min(start, end);
                    const max = Math.max(start, end);
                    
                    for (let i = min; i <= max; i++) {
                        checkboxes[i].checked = e.target.checked;
                    }
                }
                lastCheckedBox = e.target;
            }
        });

        // 7. ì„ íƒ í•­ëª© ë‹¤ì¤‘ ì‚­ì œ
        document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
            const checkedBoxes = tableBody.querySelectorAll('.row-checkbox:checked');
            if (checkedBoxes.length === 0) {
                return alert("ì‚­ì œí•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            }

            if (confirm(`ì„ íƒí•œ ${checkedBoxes.length}ê°œì˜ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                checkedBoxes.forEach(box => {
                    box.closest('tr').remove();
                });
                lastCheckedBox = null; 
            }
        });

        // 8. Firebase ì €ì¥
        document.getElementById('saveFirebaseBtn').addEventListener('click', async () => {
            const rows = tableBody.querySelectorAll('tr');
            const dataToSave = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td.editable');
                dataToSave.push({
                    name: getCellText(cells[0]),
                    phone: getCellText(cells[1]),
                    manager: getCellText(cells[2])
                });
            });

            try {
                await setDoc(docRef, { list: dataToSave });
                alert('Firebaseì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                console.error("ì €ì¥ ì‹¤íŒ¨:", e);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        });

        loadData();
    </script>
</body>
</html>